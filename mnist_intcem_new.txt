INFO:root:Results will be dumped in results/mnist_intcem
DEBUG:root:And the dataset's root directory is /home/xty20/data
[rank: 0] Global seed set to 42
DEBUG:root:		Updated concept group map (with 8 groups):
DEBUG:root:			0 -> [0, 1, 2]
DEBUG:root:			1 -> [3, 4, 5]
DEBUG:root:			2 -> [6, 7, 8]
DEBUG:root:			5 -> [9, 10, 11, 12, 13]
DEBUG:root:			8 -> [14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
DEBUG:root:			9 -> [24, 25, 26, 27, 28, 29, 30, 31, 32, 33]
DEBUG:root:			10 -> [34, 35, 36, 37, 38, 39, 40, 41, 42, 43]
DEBUG:root:			11 -> [44, 45, 46, 47, 48, 49, 50, 51, 52, 53]
/home/xty20/cem/venv/lib/python3.8/site-packages/pytorch_lightning/utilities/seed.py:47: LightningDeprecationWarning: `pytorch_lightning.utilities.seed.seed_everything` has been deprecated in v1.8.0 and will be removed in v2.0.0. Please use `lightning_fabric.utilities.seed.seed_everything` instead.
  rank_zero_deprecation(
[rank: 0] Global seed set to 42
{
    "batch_size": 512,
    "c2y_layers": [
        128,
        128
    ],
    "c_extractor_arch": "Function: c_extractor_arch",
    "check_val_every_n_epoch": 2,
    "dataset": "mnist_add",
    "intervention_batch_size": 512,
    "intervention_freq": 1,
    "intervention_policies": [
        "intcem_policy",
        "optimal_greedy_no_prior",
        "group_random_no_prior",
        "group_coop_no_prior"
    ],
    "max_epochs": 300,
    "noise_level": 0.0,
    "num_operands": 12,
    "num_workers": 8,
    "results_dir": "results/mnist_intcem",
    "root_dir": "/home/xty20/data",
    "runs": [
        {
            "architecture": "IntAwareConceptEmbeddingModel",
            "average_trajectory": true,
            "beta_a": 1,
            "beta_b": 3,
            "embedding_activation": "leakyrelu",
            "extra_name": "Retry_concept_loss_weight_{concept_loss_weight}_intervention_weight_{intervention_weight}_horizon_rate_{horizon_rate}_intervention_discount_{intervention_discount}_task_discount_{intervention_task_discount}_sampling_percent_{sampling_percent}",
            "horizon_binary_representation": true,
            "horizon_rate": 1.005,
            "horizon_uniform_distr": true,
            "include_only_last_trajectory_loss": true,
            "include_task_trajectory_loss": true,
            "initial_horizon": 2,
            "initialize_discount": false,
            "int_model_layers": [
                128,
                128,
                64,
                64
            ],
            "int_model_use_bn": true,
            "intcem_task_loss_weight": 0,
            "intervention_discount": 1,
            "intervention_task_discount": 1.1,
            "intervention_task_loss_weight": 1,
            "intervention_weight": 1,
            "legacy_mode": false,
            "max_horizon": 6,
            "model_pretrain_path": null,
            "propagate_target_gradients": false,
            "task_loss_weight": 0,
            "tau": 1,
            "training_intervention_prob": 0.25,
            "use_concept_groups": true,
            "use_full_mask_distr": false,
            "use_horizon": false
        }
    ],
    "sampling_groups": true,
    "sampling_percent": 0.625,
    "selected_digits": [
        [
            0,
            1,
            2
        ],
        [
            0,
            1,
            2
        ],
        [
            0,
            1,
            2
        ],
        [
            0,
            1,
            2
        ],
        [
            0,
            1,
            2,
            3,
            4
        ],
        [
            0,
            1,
            2,
            3,
            4
        ],
        [
            0,
            1,
            2,
            3,
            4
        ],
        [
            0,
            1,
            2,
            3,
            4
        ],
        [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9
        ],
        [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9
        ],
        [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9
        ],
        [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9
        ]
    ],
    "shared_params": {
        "ac_model_config": {
            "affine_hids": [
                256,
                256
            ],
            "architecture": "flow",
            "batch_size": 512,
            "clip_gradient": 1,
            "coupling_hids": [
                256,
                256
            ],
            "decay_rate": 0.5,
            "decay_steps": 10000,
            "layer_cfg": [
                "LR",
                "CP2"
            ],
            "learning_rate": 0.0001,
            "linear_hids": [
                256,
                256
            ],
            "linear_rank": -1,
            "max_epochs": 50,
            "n_components": 40,
            "num_samples": 10,
            "optimizer": "adam",
            "prior": "autoreg",
            "prior_hids": [
                256,
                256
            ],
            "prior_layers": 2,
            "prior_units": 256,
            "rnncp_layers": 2,
            "rnncp_units": 256,
            "save_path": "/home/xty20/cem/results/afa/mnist_acflow_cem/acflow_model_trial_0.pt",
            "transformations": [
                "AF",
                "TL",
                "TL",
                "TL",
                "TL",
                "AF"
            ]
        },
        "ac_model_nll_ratio": 0.5,
        "ac_model_rollouts": 1,
        "ac_model_weight": 2,
        "afa_model_config": {
            "act_fun": "relu",
            "clip_coef": 0.2,
            "clip_vloss": false,
            "ent_coef": 0.0,
            "normalize_advantages": false,
            "num_envs": 1,
            "ortho_init": false,
            "vf_coef": 1.0
        },
        "bool": false,
        "c_extractor_arch": "resnet18",
        "cbm_aneal_rate": 0.99999,
        "cbm_starting_aneal_rate": 1,
        "concept_loss_weight": 5,
        "continue_training": false,
        "early_stopping_delta": 0.0,
        "early_stopping_mode": "min",
        "early_stopping_monitor": "val_loss",
        "emb_size": 16,
        "enable_checkpointing": true,
        "extra_dims": 0,
        "learning_rate": 0.0001,
        "momentum": 0.9,
        "only_train_ac_model": false,
        "optimizer": "adam",
        "patience": null,
        "save_model": true,
        "sigmoidal_prob": false,
        "start_split": 0,
        "top_k_accuracy": null,
        "train_ac_model": false,
        "train_afa_model": false,
        "training_intervention_prob": 0.25,
        "weight_decay": 0.001
    },
    "skip_repr_evaluation": true,
    "test_subsampling": 1,
    "threshold_labels": 30,
    "train_dataset_size": 10000,
    "trials": 3,
    "use_task_class_weights": true,
    "weight_loss": true
}
INFO:root:Training sample shape is: torch.Size([512, 12, 28, 28]) with type torch.FloatTensor
INFO:root:Training label shape is: torch.Size([512]) with type torch.FloatTensor
INFO:root:	Number of output classes: 1
INFO:root:Training concept shape is: torch.Size([512, 54]) with type torch.FloatTensor
INFO:root:	Number of training concepts: 54
INFO:root:Computing task class weights in the training dataset with size 20...
INFO:root:Setting log level to: "DEBUG"
DEBUG:root:Setting ac model save path to be results/mnist_intcem/acflow_sampling_0.625_model_trial_0.pt
[rank: 0] Global seed set to 42
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1.ckpt
DEBUG:root:Loaded model
DEBUG:root:Restarting run because we could not find val_acc_c_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
DEBUG:root:Getting validation results.
Class distribution is: [0.4847 0.5153]
[TRIAL 1/3 BEGINS AT 22/05/2024 at 19:45:09
[Training IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1]
config:
<built-in function localtime>
	start_split -> 0
	top_k_accuracy -> None
	save_model -> True
	patience -> None
	emb_size -> 16
	extra_dims -> 0
	concept_loss_weight -> 5
	learning_rate -> 0.0001
	weight_decay -> 0.001
	c_extractor_arch -> <function get_mnist_extractor_arch.<locals>.c_extractor_arch at 0x7fadf574fdc0>
	optimizer -> adam
	bool -> False
	early_stopping_monitor -> val_loss
	early_stopping_mode -> min
	early_stopping_delta -> 0.0
	momentum -> 0.9
	sigmoidal_prob -> False
	training_intervention_prob -> 0.25
	train_ac_model -> False
	only_train_ac_model -> False
	train_afa_model -> False
	continue_training -> False
	cbm_aneal_rate -> 0.99999
	cbm_starting_aneal_rate -> 1
	enable_checkpointing -> True
	ac_model_config -> {'save_path': 'results/mnist_intcem/acflow_sampling_0.625_model_trial_0.pt', 'architecture': 'flow', 'max_epochs': 50, 'batch_size': 512, 'transformations': ['AF', 'TL', 'TL', 'TL', 'TL', 'AF'], 'layer_cfg': ['LR', 'CP2'], 'rnncp_units': 256, 'rnncp_layers': 2, 'linear_hids': [256, 256], 'linear_rank': -1, 'affine_hids': [256, 256], 'coupling_hids': [256, 256], 'prior': 'autoreg', 'n_components': 40, 'prior_units': 256, 'prior_layers': 2, 'prior_hids': [256, 256], 'optimizer': 'adam', 'learning_rate': 0.0001, 'decay_steps': 10000, 'decay_rate': 0.5, 'clip_gradient': 1, 'num_samples': 10}
	ac_model_nll_ratio -> 0.5
	ac_model_weight -> 2
	ac_model_rollouts -> 1
	afa_model_config -> {'act_fun': 'relu', 'ortho_init': False, 'vf_coef': 1.0, 'ent_coef': 0.0, 'clip_coef': 0.2, 'clip_vloss': False, 'normalize_advantages': False, 'num_envs': 1}
	trials -> 3
	results_dir -> results/mnist_intcem
	dataset -> mnist_add
	num_workers -> 8
	batch_size -> 512
	num_operands -> 12
	selected_digits -> [[0, 1, 2], [0, 1, 2], [0, 1, 2], [0, 1, 2], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]]
	threshold_labels -> 30
	noise_level -> 0.0
	max_epochs -> 300
	train_dataset_size -> 10000
	sampling_percent -> 0.625
	sampling_groups -> True
	c2y_layers -> [128, 128]
	skip_repr_evaluation -> True
	intervention_freq -> 1
	intervention_batch_size -> 512
	intervention_policies -> ['intcem_policy', 'optimal_greedy_no_prior', 'group_random_no_prior', 'group_coop_no_prior']
	root_dir -> /home/xty20/data
	test_subsampling -> 1
	weight_loss -> True
	use_task_class_weights -> True
	check_val_every_n_epoch -> 2
	time_last_called -> 2024/05/22 at 19:44:49
	n_concepts -> 54
	n_tasks -> 1
	concept_map -> {0: [0, 1, 2], 1: [3, 4, 5], 2: [6, 7, 8], 5: [9, 10, 11, 12, 13], 8: [14, 15, 16, 17, 18, 19, 20, 21, 22, 23], 9: [24, 25, 26, 27, 28, 29, 30, 31, 32, 33], 10: [34, 35, 36, 37, 38, 39, 40, 41, 42, 43], 11: [44, 45, 46, 47, 48, 49, 50, 51, 52, 53]}
	architecture -> IntAwareConceptEmbeddingModel
	extra_name -> Retry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625
	horizon_binary_representation -> True
	include_task_trajectory_loss -> True
	include_only_last_trajectory_loss -> True
	task_loss_weight -> 0
	intervention_weight -> 1
	intervention_task_loss_weight -> 1
	initial_horizon -> 2
	use_concept_groups -> True
	use_full_mask_distr -> False
	propagate_target_gradients -> False
	int_model_use_bn -> True
	int_model_layers -> [128, 128, 64, 64]
	intcem_task_loss_weight -> 0
	embedding_activation -> leakyrelu
	tau -> 1
	max_horizon -> 6
	horizon_uniform_distr -> True
	beta_a -> 1
	beta_b -> 3
	intervention_task_discount -> 1.1
	average_trajectory -> True
	use_horizon -> False
	initialize_discount -> False
	model_pretrain_path -> None
	horizon_rate -> 1.005
	intervention_discount -> 1
	legacy_mode -> False
[Number of parameters in model 2116331 ]
[Number of non-trainable parameters in model 2 ]
	Found cached model... loading it
Testing: 0it [00:00, ?it/s]Testing:   0%|          | 0/4 [00:00<?, ?it/s]Testing DataLoader 0:   0%|          | 0/4 [00:00<?, ?it/s]Testing DataLoader 0:  25%|██▌       | 1/4 [00:01<00:05,  1.76s/it]Testing DataLoader 0:  50%|█████     | 2/4 [00:01<00:01,  1.03it/s]Testing DataLoader 0:  75%|███████▌  | 3/4 [00:02<00:00,  1.42it/s]Testing DataLoader 0: 100%|██████████| 4/4 [00:02<00:00,  1.74it/s]Testing DataLoader 0: 100%|██████████| 4/4 [00:02<00:00,  1.71it/s]DEBUG:root:Restarting run because we could not find test_acc_c_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
DEBUG:root:Getting test results without interventions.

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_avg_c_y_acc          0.8711435185185185
      test_c_accuracy          0.9562870370370371
        test_c_auc              0.893070808034882
         test_c_f1             0.9065811529954255
     test_concept_loss         3.5693681240081787
    test_current_steps         1500.4639892578125
    test_horizon_limit          9.019449234008789
  test_intervention_loss               0.0
test_intervention_task_loss            0.0
         test_loss             3.5693681240081787
    test_mask_accuracy                -1.0
      test_task_loss                   0.0
      test_y_accuracy                 0.786
        test_y_auc             0.8898994593637982
         test_y_f1             0.7802782178932574
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
val_c_acc: 95.63%, val_y_acc: 78.60%, val_c_auc: 89.31%, val_y_auc: 88.99% with 78.0 epochs in 1090.88 seconds
Testing: 0it [00:00, ?it/s]Testing:   0%|          | 0/20 [00:00<?, ?it/s]Testing DataLoader 0:   0%|          | 0/20 [00:00<?, ?it/s]Testing DataLoader 0:   5%|▌         | 1/20 [00:00<00:03,  5.33it/s]Testing DataLoader 0:  10%|█         | 2/20 [00:00<00:03,  5.32it/s]Testing DataLoader 0:  15%|█▌        | 3/20 [00:00<00:03,  5.41it/s]Testing DataLoader 0:  20%|██        | 4/20 [00:00<00:02,  5.44it/s]Testing DataLoader 0:  25%|██▌       | 5/20 [00:00<00:02,  5.48it/s]Testing DataLoader 0:  30%|███       | 6/20 [00:01<00:02,  5.49it/s]Testing DataLoader 0:  35%|███▌      | 7/20 [00:01<00:02,  5.50it/s]Testing DataLoader 0:  40%|████      | 8/20 [00:01<00:02,  5.52it/s]Testing DataLoader 0:  45%|████▌     | 9/20 [00:01<00:01,  5.53it/s]Testing DataLoader 0:  50%|█████     | 10/20 [00:01<00:01,  5.54it/s]Testing DataLoader 0:  55%|█████▌    | 11/20 [00:01<00:01,  5.55it/s]Testing DataLoader 0:  60%|██████    | 12/20 [00:02<00:01,  5.56it/s]Testing DataLoader 0:  65%|██████▌   | 13/20 [00:02<00:01,  5.57it/s]Testing DataLoader 0:  70%|███████   | 14/20 [00:02<00:01,  5.58it/s]Testing DataLoader 0:  75%|███████▌  | 15/20 [00:02<00:00,  5.58it/s]Testing DataLoader 0:  80%|████████  | 16/20 [00:02<00:00,  5.59it/s]Testing DataLoader 0:  85%|████████▌ | 17/20 [00:03<00:00,  5.59it/s]Testing DataLoader 0:  90%|█████████ | 18/20 [00:03<00:00,  5.60it/s]Testing DataLoader 0:  95%|█████████▌| 19/20 [00:03<00:00,  5.60it/s]Testing DataLoader 0: 100%|██████████| 20/20 [00:03<00:00,  5.60it/s]Testing DataLoader 0: 100%|██████████| 20/20 [00:03<00:00,  5.60it/s]DEBUG:root:Restarting run because we could not find test_acc_y_intcem_policy_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 42
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1.ckpt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.intcem_policy.IntCemInterventionPolicy'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 0 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.36% (accuracy is 79.13%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 0 with 1 groups intervened

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_avg_c_y_acc          0.8718888888888887
      test_c_accuracy           0.957577777777778
        test_c_auc             0.8966633723510542
         test_c_f1             0.9098665660708041
     test_concept_loss         3.4669928550720215
    test_current_steps          1512.27197265625
    test_horizon_limit          9.019449234008789
  test_intervention_loss               0.0
test_intervention_task_loss            0.0
         test_loss             3.4669928550720215
    test_mask_accuracy                -1.0
      test_task_loss                   0.0
      test_y_accuracy                0.7862
        test_y_auc              0.883382742175583
         test_y_f1             0.7711990097961858
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
c_acc: 95.76%, y_acc: 78.62%, c_auc: 89.67%, y_auc: 88.34% with 78.0 epochs in 1090.88 seconds
Traceback (most recent call last):
  File "experiments/run_experiments_rl.py", line 913, in <module>
    main(
  File "experiments/run_experiments_rl.py", line 509, in main
    intervention_utils.test_interventions(
  File "/home/xty20/cem/venv/lib/python3.8/site-packages/cem-1.1.0-py3.8.egg/cem/interventions/utils.py", line 1412, in test_interventions
  File "/home/xty20/cem/venv/lib/python3.8/site-packages/cem-1.1.0-py3.8.egg/cem/train/utils.py", line 90, in load_call
  File "/home/xty20/cem/venv/lib/python3.8/site-packages/cem-1.1.0-py3.8.egg/cem/interventions/utils.py", line 511, in intervene_in_cbm
TypeError: 'NoneType' object is not iterable
INFO:root:Results will be dumped in results/mnist_intcem
DEBUG:root:And the dataset's root directory is /home/xty20/data
[rank: 0] Global seed set to 42
DEBUG:root:		Updated concept group map (with 8 groups):
DEBUG:root:			0 -> [0, 1, 2]
DEBUG:root:			1 -> [3, 4, 5]
DEBUG:root:			2 -> [6, 7, 8]
DEBUG:root:			5 -> [9, 10, 11, 12, 13]
DEBUG:root:			8 -> [14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
DEBUG:root:			9 -> [24, 25, 26, 27, 28, 29, 30, 31, 32, 33]
DEBUG:root:			10 -> [34, 35, 36, 37, 38, 39, 40, 41, 42, 43]
DEBUG:root:			11 -> [44, 45, 46, 47, 48, 49, 50, 51, 52, 53]
/home/xty20/cem/venv/lib/python3.8/site-packages/pytorch_lightning/utilities/seed.py:47: LightningDeprecationWarning: `pytorch_lightning.utilities.seed.seed_everything` has been deprecated in v1.8.0 and will be removed in v2.0.0. Please use `lightning_fabric.utilities.seed.seed_everything` instead.
  rank_zero_deprecation(
[rank: 0] Global seed set to 42
{
    "batch_size": 512,
    "c2y_layers": [
        128,
        128
    ],
    "c_extractor_arch": "Function: c_extractor_arch",
    "check_val_every_n_epoch": 2,
    "dataset": "mnist_add",
    "intervention_batch_size": 512,
    "intervention_freq": 1,
    "intervention_policies": [
        "intcem_policy",
        "optimal_greedy_no_prior",
        "group_random_no_prior",
        "group_coop_no_prior"
    ],
    "max_epochs": 300,
    "noise_level": 0.0,
    "num_operands": 12,
    "num_workers": 8,
    "results_dir": "results/mnist_intcem",
    "root_dir": "/home/xty20/data",
    "runs": [
        {
            "architecture": "IntAwareConceptEmbeddingModel",
            "average_trajectory": true,
            "beta_a": 1,
            "beta_b": 3,
            "embedding_activation": "leakyrelu",
            "extra_name": "Retry_concept_loss_weight_{concept_loss_weight}_intervention_weight_{intervention_weight}_horizon_rate_{horizon_rate}_intervention_discount_{intervention_discount}_task_discount_{intervention_task_discount}_sampling_percent_{sampling_percent}",
            "horizon_binary_representation": true,
            "horizon_rate": 1.005,
            "horizon_uniform_distr": true,
            "include_only_last_trajectory_loss": true,
            "include_task_trajectory_loss": true,
            "initial_horizon": 2,
            "initialize_discount": false,
            "int_model_layers": [
                128,
                128,
                64,
                64
            ],
            "int_model_use_bn": true,
            "intcem_task_loss_weight": 0,
            "intervention_discount": 1,
            "intervention_task_discount": 1.1,
            "intervention_task_loss_weight": 1,
            "intervention_weight": 1,
            "legacy_mode": false,
            "max_horizon": 6,
            "model_pretrain_path": null,
            "propagate_target_gradients": false,
            "task_loss_weight": 0,
            "tau": 1,
            "training_intervention_prob": 0.25,
            "use_concept_groups": true,
            "use_full_mask_distr": false,
            "use_horizon": false
        }
    ],
    "sampling_groups": true,
    "sampling_percent": 0.625,
    "selected_digits": [
        [
            0,
            1,
            2
        ],
        [
            0,
            1,
            2
        ],
        [
            0,
            1,
            2
        ],
        [
            0,
            1,
            2
        ],
        [
            0,
            1,
            2,
            3,
            4
        ],
        [
            0,
            1,
            2,
            3,
            4
        ],
        [
            0,
            1,
            2,
            3,
            4
        ],
        [
            0,
            1,
            2,
            3,
            4
        ],
        [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9
        ],
        [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9
        ],
        [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9
        ],
        [
            0,
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9
        ]
    ],
    "shared_params": {
        "ac_model_config": {
            "affine_hids": [
                256,
                256
            ],
            "architecture": "flow",
            "batch_size": 512,
            "clip_gradient": 1,
            "coupling_hids": [
                256,
                256
            ],
            "decay_rate": 0.5,
            "decay_steps": 10000,
            "layer_cfg": [
                "LR",
                "CP2"
            ],
            "learning_rate": 0.0001,
            "linear_hids": [
                256,
                256
            ],
            "linear_rank": -1,
            "max_epochs": 50,
            "n_components": 40,
            "num_samples": 10,
            "optimizer": "adam",
            "prior": "autoreg",
            "prior_hids": [
                256,
                256
            ],
            "prior_layers": 2,
            "prior_units": 256,
            "rnncp_layers": 2,
            "rnncp_units": 256,
            "save_path": "/home/xty20/cem/results/afa/mnist_acflow_cem/acflow_model_trial_0.pt",
            "transformations": [
                "AF",
                "TL",
                "TL",
                "TL",
                "TL",
                "AF"
            ]
        },
        "ac_model_nll_ratio": 0.5,
        "ac_model_rollouts": 1,
        "ac_model_weight": 2,
        "afa_model_config": {
            "act_fun": "relu",
            "clip_coef": 0.2,
            "clip_vloss": false,
            "ent_coef": 0.0,
            "normalize_advantages": false,
            "num_envs": 1,
            "ortho_init": false,
            "vf_coef": 1.0
        },
        "bool": false,
        "c_extractor_arch": "resnet18",
        "cbm_aneal_rate": 0.99999,
        "cbm_starting_aneal_rate": 1,
        "concept_loss_weight": 5,
        "continue_training": false,
        "early_stopping_delta": 0.0,
        "early_stopping_mode": "min",
        "early_stopping_monitor": "val_loss",
        "emb_size": 16,
        "enable_checkpointing": false,
        "extra_dims": 0,
        "learning_rate": 0.0001,
        "momentum": 0.9,
        "only_train_ac_model": false,
        "optimizer": "adam",
        "patience": null,
        "save_model": true,
        "sigmoidal_prob": false,
        "start_split": 0,
        "top_k_accuracy": null,
        "train_ac_model": false,
        "train_afa_model": false,
        "training_intervention_prob": 0.25,
        "weight_decay": 0.001
    },
    "skip_repr_evaluation": true,
    "test_subsampling": 1,
    "threshold_labels": 30,
    "train_dataset_size": 10000,
    "trials": 3,
    "use_task_class_weights": true,
    "weight_loss": true
}
INFO:root:Training sample shape is: torch.Size([512, 12, 28, 28]) with type torch.FloatTensor
INFO:root:Training label shape is: torch.Size([512]) with type torch.FloatTensor
INFO:root:	Number of output classes: 1
INFO:root:Training concept shape is: torch.Size([512, 54]) with type torch.FloatTensor
INFO:root:	Number of training concepts: 54
INFO:root:Computing task class weights in the training dataset with size 20...
INFO:root:Setting log level to: "DEBUG"
DEBUG:root:Setting ac model save path to be results/mnist_intcem/acflow_sampling_0.625_model_trial_0.pt
[rank: 0] Global seed set to 42
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1.pt
DEBUG:root:Loaded model
DEBUG:root:Restarting run because we could not find val_acc_c_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
DEBUG:root:Getting validation results.
Class distribution is: [0.4847 0.5153]
[TRIAL 1/3 BEGINS AT 22/05/2024 at 19:46:03
[Training IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1]
config:
<built-in function localtime>
	start_split -> 0
	top_k_accuracy -> None
	save_model -> True
	patience -> None
	emb_size -> 16
	extra_dims -> 0
	concept_loss_weight -> 5
	learning_rate -> 0.0001
	weight_decay -> 0.001
	c_extractor_arch -> <function get_mnist_extractor_arch.<locals>.c_extractor_arch at 0x7ff55ddd5dc0>
	optimizer -> adam
	bool -> False
	early_stopping_monitor -> val_loss
	early_stopping_mode -> min
	early_stopping_delta -> 0.0
	momentum -> 0.9
	sigmoidal_prob -> False
	training_intervention_prob -> 0.25
	train_ac_model -> False
	only_train_ac_model -> False
	train_afa_model -> False
	continue_training -> False
	cbm_aneal_rate -> 0.99999
	cbm_starting_aneal_rate -> 1
	enable_checkpointing -> False
	ac_model_config -> {'save_path': 'results/mnist_intcem/acflow_sampling_0.625_model_trial_0.pt', 'architecture': 'flow', 'max_epochs': 50, 'batch_size': 512, 'transformations': ['AF', 'TL', 'TL', 'TL', 'TL', 'AF'], 'layer_cfg': ['LR', 'CP2'], 'rnncp_units': 256, 'rnncp_layers': 2, 'linear_hids': [256, 256], 'linear_rank': -1, 'affine_hids': [256, 256], 'coupling_hids': [256, 256], 'prior': 'autoreg', 'n_components': 40, 'prior_units': 256, 'prior_layers': 2, 'prior_hids': [256, 256], 'optimizer': 'adam', 'learning_rate': 0.0001, 'decay_steps': 10000, 'decay_rate': 0.5, 'clip_gradient': 1, 'num_samples': 10}
	ac_model_nll_ratio -> 0.5
	ac_model_weight -> 2
	ac_model_rollouts -> 1
	afa_model_config -> {'act_fun': 'relu', 'ortho_init': False, 'vf_coef': 1.0, 'ent_coef': 0.0, 'clip_coef': 0.2, 'clip_vloss': False, 'normalize_advantages': False, 'num_envs': 1}
	trials -> 3
	results_dir -> results/mnist_intcem
	dataset -> mnist_add
	num_workers -> 8
	batch_size -> 512
	num_operands -> 12
	selected_digits -> [[0, 1, 2], [0, 1, 2], [0, 1, 2], [0, 1, 2], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]]
	threshold_labels -> 30
	noise_level -> 0.0
	max_epochs -> 300
	train_dataset_size -> 10000
	sampling_percent -> 0.625
	sampling_groups -> True
	c2y_layers -> [128, 128]
	skip_repr_evaluation -> True
	intervention_freq -> 1
	intervention_batch_size -> 512
	intervention_policies -> ['intcem_policy', 'optimal_greedy_no_prior', 'group_random_no_prior', 'group_coop_no_prior']
	root_dir -> /home/xty20/data
	test_subsampling -> 1
	weight_loss -> True
	use_task_class_weights -> True
	check_val_every_n_epoch -> 2
	time_last_called -> 2024/05/22 at 19:45:42
	n_concepts -> 54
	n_tasks -> 1
	concept_map -> {0: [0, 1, 2], 1: [3, 4, 5], 2: [6, 7, 8], 5: [9, 10, 11, 12, 13], 8: [14, 15, 16, 17, 18, 19, 20, 21, 22, 23], 9: [24, 25, 26, 27, 28, 29, 30, 31, 32, 33], 10: [34, 35, 36, 37, 38, 39, 40, 41, 42, 43], 11: [44, 45, 46, 47, 48, 49, 50, 51, 52, 53]}
	architecture -> IntAwareConceptEmbeddingModel
	extra_name -> Retry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625
	horizon_binary_representation -> True
	include_task_trajectory_loss -> True
	include_only_last_trajectory_loss -> True
	task_loss_weight -> 0
	intervention_weight -> 1
	intervention_task_loss_weight -> 1
	initial_horizon -> 2
	use_concept_groups -> True
	use_full_mask_distr -> False
	propagate_target_gradients -> False
	int_model_use_bn -> True
	int_model_layers -> [128, 128, 64, 64]
	intcem_task_loss_weight -> 0
	embedding_activation -> leakyrelu
	tau -> 1
	max_horizon -> 6
	horizon_uniform_distr -> True
	beta_a -> 1
	beta_b -> 3
	intervention_task_discount -> 1.1
	average_trajectory -> True
	use_horizon -> False
	initialize_discount -> False
	model_pretrain_path -> None
	horizon_rate -> 1.005
	intervention_discount -> 1
	legacy_mode -> False
[Number of parameters in model 2116331 ]
[Number of non-trainable parameters in model 2 ]
	Found cached model... loading it
Testing: 0it [00:00, ?it/s]Testing:   0%|          | 0/4 [00:00<?, ?it/s]Testing DataLoader 0:   0%|          | 0/4 [00:00<?, ?it/s]Testing DataLoader 0:  25%|██▌       | 1/4 [00:00<00:01,  2.91it/s]Testing DataLoader 0:  50%|█████     | 2/4 [00:00<00:00,  3.79it/s]Testing DataLoader 0:  75%|███████▌  | 3/4 [00:00<00:00,  4.25it/s]Testing DataLoader 0: 100%|██████████| 4/4 [00:00<00:00,  4.50it/s]Testing DataLoader 0: 100%|██████████| 4/4 [00:00<00:00,  4.47it/s]DEBUG:root:Restarting run because we could not find test_acc_c_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
DEBUG:root:Getting test results without interventions.

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_avg_c_y_acc          0.8742453703703703
      test_c_accuracy          0.9579907407407408
        test_c_auc             0.8954113355186023
         test_c_f1             0.9086420930307031
     test_concept_loss          3.62662410736084
    test_current_steps         1720.4639892578125
    test_horizon_limit          9.019449234008789
  test_intervention_loss               0.0
test_intervention_task_loss            0.0
         test_loss              3.62662410736084
    test_mask_accuracy                -1.0
      test_task_loss                   0.0
      test_y_accuracy                0.7905
        test_y_auc             0.8888857125244994
         test_y_f1             0.7899111257089617
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
val_c_acc: 95.80%, val_y_acc: 79.05%, val_c_auc: 89.54%, val_y_auc: 88.89% with 78.0 epochs in 1090.88 seconds
Testing: 0it [00:00, ?it/s]Testing:   0%|          | 0/20 [00:00<?, ?it/s]Testing DataLoader 0:   0%|          | 0/20 [00:00<?, ?it/s]Testing DataLoader 0:   5%|▌         | 1/20 [00:00<00:03,  4.92it/s]Testing DataLoader 0:  10%|█         | 2/20 [00:00<00:03,  5.20it/s]Testing DataLoader 0:  15%|█▌        | 3/20 [00:00<00:03,  5.32it/s]Testing DataLoader 0:  20%|██        | 4/20 [00:00<00:02,  5.37it/s]Testing DataLoader 0:  25%|██▌       | 5/20 [00:00<00:02,  5.40it/s]Testing DataLoader 0:  30%|███       | 6/20 [00:01<00:02,  5.44it/s]Testing DataLoader 0:  35%|███▌      | 7/20 [00:01<00:02,  5.47it/s]Testing DataLoader 0:  40%|████      | 8/20 [00:01<00:02,  5.49it/s]Testing DataLoader 0:  45%|████▌     | 9/20 [00:01<00:01,  5.51it/s]Testing DataLoader 0:  50%|█████     | 10/20 [00:01<00:01,  5.52it/s]Testing DataLoader 0:  55%|█████▌    | 11/20 [00:01<00:01,  5.54it/s]Testing DataLoader 0:  60%|██████    | 12/20 [00:02<00:01,  5.55it/s]Testing DataLoader 0:  65%|██████▌   | 13/20 [00:02<00:01,  5.55it/s]Testing DataLoader 0:  70%|███████   | 14/20 [00:02<00:01,  5.56it/s]Testing DataLoader 0:  75%|███████▌  | 15/20 [00:02<00:00,  5.57it/s]Testing DataLoader 0:  80%|████████  | 16/20 [00:02<00:00,  5.57it/s]Testing DataLoader 0:  85%|████████▌ | 17/20 [00:03<00:00,  5.58it/s]Testing DataLoader 0:  90%|█████████ | 18/20 [00:03<00:00,  5.58it/s]Testing DataLoader 0:  95%|█████████▌| 19/20 [00:03<00:00,  5.59it/s]Testing DataLoader 0: 100%|██████████| 20/20 [00:03<00:00,  5.59it/s]Testing DataLoader 0: 100%|██████████| 20/20 [00:03<00:00,  5.59it/s]DEBUG:root:Restarting run because we could not find test_acc_y_intcem_policy_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 42
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.intcem_policy.IntCemInterventionPolicy'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 0 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.36% (accuracy is 79.55%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 0 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 90.10% (accuracy is 82.41%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 0 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 90.74% (accuracy is 83.05%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 0 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 90.97% (accuracy is 83.30%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 0 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 91.14% (accuracy is 83.49%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 0 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 91.37% (accuracy is 83.60%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 0 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 91.79% (accuracy is 83.92%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 0 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 92.68% (accuracy is 84.39%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 0 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 94.09% (accuracy is 85.36%).
DEBUG:root:	Average intervention took 0.00025 seconds and construction took 0.00009 seconds.
	In total interventions took 22.53121 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.36% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 90.10% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 90.74% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 90.97% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 91.14% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 91.37% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 91.79% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 92.68% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 94.09% (avg int time is 0.00025s and construction time is 0.00009s).
DEBUG:root:Restarting run because we could not find test_acc_y_optimal_greedy_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 42
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.optimal.GreedyOptimal'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 0 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.36% (accuracy is 79.55%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 0 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 95.87% (accuracy is 88.70%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 0 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 97.47% (accuracy is 91.14%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 0 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 97.92% (accuracy is 92.01%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 0 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 98.05% (accuracy is 92.26%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 0 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 98.04% (accuracy is 92.18%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 0 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 97.88% (accuracy is 91.91%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 0 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 97.28% (accuracy is 90.70%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 0 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 94.09% (accuracy is 85.36%).
DEBUG:root:	Average intervention took 0.00025 seconds and construction took 0.00007 seconds.
	In total interventions took 22.28444 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.36% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 95.87% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 97.47% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 97.92% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 98.05% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 98.04% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 97.88% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 97.28% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 94.09% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:Restarting run because we could not find test_acc_y_group_random_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 42
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.random.IndependentRandomMaskIntPolicy'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 0 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.36% (accuracy is 79.55%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 0 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 89.08% (accuracy is 80.38%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 0 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 89.61% (accuracy is 81.24%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 0 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 90.49% (accuracy is 81.98%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 0 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 91.28% (accuracy is 82.57%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 0 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 91.91% (accuracy is 83.35%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 0 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 92.62% (accuracy is 83.96%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 0 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 93.40% (accuracy is 84.55%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 0 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 94.09% (accuracy is 85.36%).
DEBUG:root:	Average intervention took 0.00013 seconds and construction took 0.00003 seconds.
	In total interventions took 11.42532 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.36% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 89.08% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 89.61% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 90.49% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 91.28% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 91.91% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 92.62% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 93.40% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 94.09% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:Restarting run because we could not find test_acc_y_group_coop_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 42
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1.pt
[rank: 0] Global seed set to 42
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_1.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.coop.CooP'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 0 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.36% (accuracy is 79.55%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 0 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 88.63% (accuracy is 79.69%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 0 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 88.94% (accuracy is 80.16%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 0 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 89.84% (accuracy is 80.91%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 0 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 91.34% (accuracy is 82.75%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 0 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 92.56% (accuracy is 83.83%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 0 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 93.46% (accuracy is 84.77%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 0 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 93.90% (accuracy is 85.15%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 0 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 94.09% (accuracy is 85.36%).
DEBUG:root:	Average intervention took 0.00031 seconds and construction took 58.94115 seconds.
	In total interventions took 27.96505 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.36% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 88.63% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 88.94% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 89.84% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 91.34% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 92.56% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 93.46% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 93.90% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 94.09% (avg int time is 0.00031s and construction time is 58.94115s).
DEBUG:root:	Results for IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in split 0:
DEBUG:root:		test_acc_y -> 0.792
DEBUG:root:		test_auc_y -> 0.8834933539057128
DEBUG:root:		test_f1_y -> 0.7823945261568473
DEBUG:root:		test_acc_c -> 0.958837037037037
DEBUG:root:		test_auc_c -> 0.8974759247617572
DEBUG:root:		test_f1_c -> 0.9107937217328897
DEBUG:root:		training_epochs -> 78.0
DEBUG:root:		training_time -> 1090.8783812522888
DEBUG:root:		num_trainable_params -> 0
DEBUG:root:		num_non_trainable_params -> 2116333
DEBUG:root:		test_acc_y_intcem_policy_ints -> [0.883630167484841, 0.900954352068703, 0.9074070402240968, 0.9096898702714301, 0.9113992907693164, 0.9137180165913696, 0.9178703813028225, 0.9267543942396698, 0.9409357133013755]
DEBUG:root:		avg_int_time_intcem_policy_ints -> 0.0002503467347886827
DEBUG:root:		construction_time_intcem_policy_ints -> 9.465217590332031e-05
DEBUG:root:		test_acc_y_optimal_greedy_no_prior_ints -> [0.883630167484841, 0.9586812903823632, 0.9747497760351743, 0.9792455494807247, 0.9805283413674925, 0.9803698111454707, 0.9788186179281679, 0.9727853868005967, 0.9409357133013755]
DEBUG:root:		avg_int_time_optimal_greedy_no_prior_ints -> 0.0002476048363579644
DEBUG:root:		construction_time_optimal_greedy_no_prior_ints -> 6.67572021484375e-05
DEBUG:root:		test_acc_y_group_random_no_prior_ints -> [0.883630167484841, 0.890793086338812, 0.8961410944977364, 0.9049080923351436, 0.9128022737747826, 0.9191126837877613, 0.9261928536804844, 0.933951799739852, 0.9409357133013755]
DEBUG:root:		avg_int_time_group_random_no_prior_ints -> 0.000126947996351454
DEBUG:root:		construction_time_group_random_no_prior_ints -> 3.24249267578125e-05
DEBUG:root:		test_acc_y_group_coop_no_prior_ints -> [0.883630167484841, 0.8863218055842752, 0.8894181213584212, 0.8984214570170974, 0.9134416285598691, 0.9256362801829798, 0.9346197294422501, 0.9390385386775546, 0.9409357133013755]
DEBUG:root:		avg_int_time_group_coop_no_prior_ints -> 0.00031072276433308915
DEBUG:root:		construction_time_group_coop_no_prior_ints -> 58.941152811050415
DEBUG:root:	Trial 1 COMPLETED for IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 ending at 22/05/2024 at 19:51:56 (5.8890 minutes):	Time Breakdown:		Initialization: 0.0000 minutes		Training: 0.0959 minutes		Test Interventions: 5.7930 minutes		Evaluate Representation Metric: 0.0001 minutes
DEBUG:root:		Done with trial 1
DEBUG:root:Setting ac model save path to be results/mnist_intcem/acflow_sampling_0.625_model_trial_1.pt
[rank: 0] Global seed set to 43
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_2.pt
DEBUG:root:Loaded model
DEBUG:root:Restarting run because we could not find val_acc_c_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
DEBUG:root:Getting validation results.

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_avg_c_y_acc          0.8754185185185186
      test_c_accuracy           0.958837037037037
        test_c_auc             0.8974759247617572
         test_c_f1             0.9107937217328897
     test_concept_loss         3.5060391426086426
    test_current_steps          1732.27197265625
    test_horizon_limit          9.019449234008789
  test_intervention_loss               0.0
test_intervention_task_loss            0.0
         test_loss             3.5060391426086426
    test_mask_accuracy                -1.0
      test_task_loss                   0.0
      test_y_accuracy                 0.792
        test_y_auc             0.8834933539057128
         test_y_f1             0.7823945261568473
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
c_acc: 95.88%, y_acc: 79.20%, c_auc: 89.75%, y_auc: 88.35% with 78.0 epochs in 1090.88 seconds
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.7955, 0.8005, 0.8085]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 1
	acquisition_weight -> 0
	Validation accuracies are: [0.797, 0.798, 0.8065]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 10
	acquisition_weight -> 0
	Validation accuracies are: [0.7975, 0.8, 0.8045]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 100
	acquisition_weight -> 0
	Validation accuracies are: [0.7975, 0.7995, 0.8035]
Attempting CooP parameters:
	concept_entropy_weight -> 1
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.793, 0.8, 0.822]
Attempting CooP parameters:
	concept_entropy_weight -> 10
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.794, 0.8015, 0.8235]
Attempting CooP parameters:
	concept_entropy_weight -> 100
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.794, 0.8015, 0.823]
Best params found for group_coop_no_prior are:
	concept_entropy_weight = 10
	importance_weight = 0.1
	acquisition_weight = 0
********** Results in between trial 1 **********
	 ******************************
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+
|                                                                               Method                                                                               |  Task Accuracy  |     Task AUC    | Concept Accuracy |   Concept AUC   |   25% Int Acc   |   50% Int Acc   |   75% Int Acc   |   100% Int Acc  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+
| IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 | 0.7920 ± 0.0000 | 0.8835 ± 0.0000 | 0.9588 ± 0.0000  | 0.8975 ± 0.0000 | 0.8961 ± 0.0000 | 0.9128 ± 0.0000 | 0.9262 ± 0.0000 | 0.9409 ± 0.0000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+



[TRIAL 2/3 BEGINS AT 22/05/2024 at 19:51:56
[Training IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_2]
config:
<built-in function localtime>
	start_split -> 0
	top_k_accuracy -> None
	save_model -> True
	patience -> None
	emb_size -> 16
	extra_dims -> 0
	concept_loss_weight -> 5
	learning_rate -> 0.0001
	weight_decay -> 0.001
	c_extractor_arch -> <function get_mnist_extractor_arch.<locals>.c_extractor_arch at 0x7ff55ddd5dc0>
	optimizer -> adam
	bool -> False
	early_stopping_monitor -> val_loss
	early_stopping_mode -> min
	early_stopping_delta -> 0.0
	momentum -> 0.9
	sigmoidal_prob -> False
	training_intervention_prob -> 0.25
	train_ac_model -> False
	only_train_ac_model -> False
	train_afa_model -> False
	continue_training -> False
	cbm_aneal_rate -> 0.99999
	cbm_starting_aneal_rate -> 1
	enable_checkpointing -> False
	ac_model_config -> {'save_path': 'results/mnist_intcem/acflow_sampling_0.625_model_trial_1.pt', 'architecture': 'flow', 'max_epochs': 50, 'batch_size': 512, 'transformations': ['AF', 'TL', 'TL', 'TL', 'TL', 'AF'], 'layer_cfg': ['LR', 'CP2'], 'rnncp_units': 256, 'rnncp_layers': 2, 'linear_hids': [256, 256], 'linear_rank': -1, 'affine_hids': [256, 256], 'coupling_hids': [256, 256], 'prior': 'autoreg', 'n_components': 40, 'prior_units': 256, 'prior_layers': 2, 'prior_hids': [256, 256], 'optimizer': 'adam', 'learning_rate': 0.0001, 'decay_steps': 10000, 'decay_rate': 0.5, 'clip_gradient': 1, 'num_samples': 10}
	ac_model_nll_ratio -> 0.5
	ac_model_weight -> 2
	ac_model_rollouts -> 1
	afa_model_config -> {'act_fun': 'relu', 'ortho_init': False, 'vf_coef': 1.0, 'ent_coef': 0.0, 'clip_coef': 0.2, 'clip_vloss': False, 'normalize_advantages': False, 'num_envs': 1}
	trials -> 3
	results_dir -> results/mnist_intcem
	dataset -> mnist_add
	num_workers -> 8
	batch_size -> 512
	num_operands -> 12
	selected_digits -> [[0, 1, 2], [0, 1, 2], [0, 1, 2], [0, 1, 2], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]]
	threshold_labels -> 30
	noise_level -> 0.0
	max_epochs -> 300
	train_dataset_size -> 10000
	sampling_percent -> 0.625
	sampling_groups -> True
	c2y_layers -> [128, 128]
	skip_repr_evaluation -> True
	intervention_freq -> 1
	intervention_batch_size -> 512
	intervention_policies -> ['intcem_policy', 'optimal_greedy_no_prior', 'group_random_no_prior', 'group_coop_no_prior']
	root_dir -> /home/xty20/data
	test_subsampling -> 1
	weight_loss -> True
	use_task_class_weights -> True
	check_val_every_n_epoch -> 2
	time_last_called -> 2024/05/22 at 19:45:42
	n_concepts -> 54
	n_tasks -> 1
	concept_map -> {0: [0, 1, 2], 1: [3, 4, 5], 2: [6, 7, 8], 5: [9, 10, 11, 12, 13], 8: [14, 15, 16, 17, 18, 19, 20, 21, 22, 23], 9: [24, 25, 26, 27, 28, 29, 30, 31, 32, 33], 10: [34, 35, 36, 37, 38, 39, 40, 41, 42, 43], 11: [44, 45, 46, 47, 48, 49, 50, 51, 52, 53]}
	architecture -> IntAwareConceptEmbeddingModel
	extra_name -> Retry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625
	horizon_binary_representation -> True
	include_task_trajectory_loss -> True
	include_only_last_trajectory_loss -> True
	task_loss_weight -> 0
	intervention_weight -> 1
	intervention_task_loss_weight -> 1
	initial_horizon -> 2
	use_concept_groups -> True
	use_full_mask_distr -> False
	propagate_target_gradients -> False
	int_model_use_bn -> True
	int_model_layers -> [128, 128, 64, 64]
	intcem_task_loss_weight -> 0
	embedding_activation -> leakyrelu
	tau -> 1
	max_horizon -> 6
	horizon_uniform_distr -> True
	beta_a -> 1
	beta_b -> 3
	intervention_task_discount -> 1.1
	average_trajectory -> True
	use_horizon -> False
	initialize_discount -> False
	model_pretrain_path -> None
	horizon_rate -> 1.005
	intervention_discount -> 1
	legacy_mode -> False
[Number of parameters in model 2116331 ]
[Number of non-trainable parameters in model 2 ]
	Found cached model... loading it
Testing: 0it [00:00, ?it/s]Testing:   0%|          | 0/4 [00:00<?, ?it/s]Testing DataLoader 0:   0%|          | 0/4 [00:00<?, ?it/s]Testing DataLoader 0:  25%|██▌       | 1/4 [00:00<00:00,  5.29it/s]Testing DataLoader 0:  50%|█████     | 2/4 [00:00<00:00,  5.39it/s]Testing DataLoader 0:  75%|███████▌  | 3/4 [00:00<00:00,  5.48it/s]Testing DataLoader 0: 100%|██████████| 4/4 [00:00<00:00,  5.53it/s]Testing DataLoader 0: 100%|██████████| 4/4 [00:00<00:00,  5.52it/s]DEBUG:root:Restarting run because we could not find test_acc_c_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
DEBUG:root:Getting test results without interventions.

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_avg_c_y_acc          0.8792685185185185
      test_c_accuracy          0.9535370370370371
        test_c_auc             0.8849317657870658
         test_c_f1             0.8994084326559488
     test_concept_loss          3.84906005859375
    test_current_steps         1676.4639892578125
    test_horizon_limit          9.019449234008789
  test_intervention_loss               0.0
test_intervention_task_loss            0.0
         test_loss              3.84906005859375
    test_mask_accuracy                -1.0
      test_task_loss                   0.0
      test_y_accuracy                 0.805
        test_y_auc             0.8823411504584033
         test_y_f1             0.8153966555246841
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
val_c_acc: 95.35%, val_y_acc: 80.50%, val_c_auc: 88.49%, val_y_auc: 88.23% with 76.0 epochs in 1062.48 seconds
Testing: 0it [00:00, ?it/s]Testing:   0%|          | 0/20 [00:00<?, ?it/s]Testing DataLoader 0:   0%|          | 0/20 [00:00<?, ?it/s]Testing DataLoader 0:   5%|▌         | 1/20 [00:00<00:05,  3.53it/s]Testing DataLoader 0:  10%|█         | 2/20 [00:00<00:04,  4.32it/s]Testing DataLoader 0:  15%|█▌        | 3/20 [00:00<00:03,  4.65it/s]Testing DataLoader 0:  20%|██        | 4/20 [00:00<00:03,  4.85it/s]Testing DataLoader 0:  25%|██▌       | 5/20 [00:01<00:03,  4.97it/s]Testing DataLoader 0:  30%|███       | 6/20 [00:01<00:02,  5.07it/s]Testing DataLoader 0:  35%|███▌      | 7/20 [00:01<00:02,  5.15it/s]Testing DataLoader 0:  40%|████      | 8/20 [00:01<00:02,  5.21it/s]Testing DataLoader 0:  45%|████▌     | 9/20 [00:01<00:02,  5.26it/s]Testing DataLoader 0:  50%|█████     | 10/20 [00:01<00:01,  5.30it/s]Testing DataLoader 0:  55%|█████▌    | 11/20 [00:02<00:01,  5.33it/s]Testing DataLoader 0:  60%|██████    | 12/20 [00:02<00:01,  5.36it/s]Testing DataLoader 0:  65%|██████▌   | 13/20 [00:02<00:01,  5.38it/s]Testing DataLoader 0:  70%|███████   | 14/20 [00:02<00:01,  5.40it/s]Testing DataLoader 0:  75%|███████▌  | 15/20 [00:02<00:00,  5.41it/s]Testing DataLoader 0:  80%|████████  | 16/20 [00:02<00:00,  5.43it/s]Testing DataLoader 0:  85%|████████▌ | 17/20 [00:03<00:00,  5.44it/s]Testing DataLoader 0:  90%|█████████ | 18/20 [00:03<00:00,  5.46it/s]Testing DataLoader 0:  95%|█████████▌| 19/20 [00:03<00:00,  5.47it/s]Testing DataLoader 0: 100%|██████████| 20/20 [00:03<00:00,  5.49it/s]Testing DataLoader 0: 100%|██████████| 20/20 [00:03<00:00,  5.48it/s]DEBUG:root:Restarting run because we could not find test_acc_y_intcem_policy_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 43
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_2.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.intcem_policy.IntCemInterventionPolicy'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 1 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.24% (accuracy is 79.91%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 1 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 90.28% (accuracy is 83.08%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 1 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 90.96% (accuracy is 84.09%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 1 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 91.29% (accuracy is 84.66%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 1 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 91.47% (accuracy is 84.64%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 1 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 91.70% (accuracy is 84.94%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 1 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 92.03% (accuracy is 85.03%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 1 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 92.89% (accuracy is 85.64%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 1 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 94.54% (accuracy is 86.49%).
DEBUG:root:	Average intervention took 0.00025 seconds and construction took 0.00007 seconds.
	In total interventions took 22.13941 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.24% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 90.28% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 90.96% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 91.29% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 91.47% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 91.70% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 92.03% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 92.89% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 94.54% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:Restarting run because we could not find test_acc_y_optimal_greedy_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 43
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_2.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.optimal.GreedyOptimal'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 1 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.24% (accuracy is 79.91%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 1 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 96.28% (accuracy is 90.11%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 1 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 97.84% (accuracy is 92.54%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 1 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 98.28% (accuracy is 93.40%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 1 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 98.41% (accuracy is 93.68%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 1 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 98.40% (accuracy is 93.65%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 1 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 98.21% (accuracy is 93.32%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 1 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 97.60% (accuracy is 92.03%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 1 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 94.54% (accuracy is 86.49%).
DEBUG:root:	Average intervention took 0.00025 seconds and construction took 0.00006 seconds.
	In total interventions took 22.33082 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.24% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 96.28% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 97.84% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 98.28% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 98.41% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 98.40% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 98.21% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 97.60% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 94.54% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:Restarting run because we could not find test_acc_y_group_random_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 43
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_2.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.random.IndependentRandomMaskIntPolicy'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 1 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.24% (accuracy is 79.91%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 1 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 89.00% (accuracy is 80.48%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 1 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 89.63% (accuracy is 81.55%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 1 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 90.62% (accuracy is 82.06%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 1 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 91.32% (accuracy is 83.05%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 1 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 92.14% (accuracy is 84.16%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 1 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 92.99% (accuracy is 84.85%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 1 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 93.68% (accuracy is 85.45%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 1 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 94.54% (accuracy is 86.49%).
DEBUG:root:	Average intervention took 0.00013 seconds and construction took 0.00003 seconds.
	In total interventions took 11.65605 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.24% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 89.00% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 89.63% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 90.62% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 91.32% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 92.14% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 92.99% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 93.68% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 94.54% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:Restarting run because we could not find test_acc_y_group_coop_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 43
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_2.pt
[rank: 0] Global seed set to 43
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_2.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.coop.CooP'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 1 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.24% (accuracy is 79.91%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 1 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 88.42% (accuracy is 80.20%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 1 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 88.76% (accuracy is 80.44%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 1 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 89.48% (accuracy is 81.13%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 1 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 91.12% (accuracy is 82.74%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 1 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 92.58% (accuracy is 84.33%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 1 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 93.69% (accuracy is 85.43%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 1 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 94.29% (accuracy is 86.29%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 1 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 94.54% (accuracy is 86.49%).
DEBUG:root:	Average intervention took 0.00031 seconds and construction took 50.23232 seconds.
	In total interventions took 28.21264 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.24% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 88.42% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 88.76% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 89.48% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 91.12% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 92.58% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 93.69% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 94.29% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 94.54% (avg int time is 0.00031s and construction time is 50.23232s).
DEBUG:root:	Results for IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in split 1:
DEBUG:root:		test_acc_y -> 0.797
DEBUG:root:		test_auc_y -> 0.8822598719501326
DEBUG:root:		test_f1_y -> 0.7959276926772559
DEBUG:root:		test_acc_c -> 0.9536351851851852
DEBUG:root:		test_auc_c -> 0.888844891509667
DEBUG:root:		test_f1_c -> 0.9015834092199447
DEBUG:root:		training_epochs -> 76.0
DEBUG:root:		training_time -> 1062.476624250412
DEBUG:root:		num_trainable_params -> 0
DEBUG:root:		num_non_trainable_params -> 2116333
DEBUG:root:		test_acc_y_intcem_policy_ints -> [0.8824402034061426, 0.9027967393195924, 0.9096127228742747, 0.9129361998090564, 0.9146528002743209, 0.9169837966217037, 0.9203317602312807, 0.9289336086808582, 0.9453814172219102]
DEBUG:root:		avg_int_time_intcem_policy_ints -> 0.000245993439356486
DEBUG:root:		construction_time_intcem_policy_ints -> 7.05718994140625e-05
DEBUG:root:		test_acc_y_optimal_greedy_no_prior_ints -> [0.8824402034061426, 0.9628461299340141, 0.9783795651647641, 0.9827974399322409, 0.9840755943993369, 0.9839995493950668, 0.982126442698336, 0.9760299873792728, 0.9453814172219102]
DEBUG:root:		avg_int_time_optimal_greedy_no_prior_ints -> 0.0002481202363967895
DEBUG:root:		construction_time_optimal_greedy_no_prior_ints -> 6.031990051269531e-05
DEBUG:root:		test_acc_y_group_random_no_prior_ints -> [0.8824402034061426, 0.8899523567905077, 0.8962636631519874, 0.9061595836700992, 0.913182828642869, 0.9213587169195582, 0.9298974426603404, 0.9368364634518357, 0.9453814172219102]
DEBUG:root:		avg_int_time_group_random_no_prior_ints -> 0.00012951161331600612
DEBUG:root:		construction_time_group_random_no_prior_ints -> 2.7418136596679688e-05
DEBUG:root:		test_acc_y_group_coop_no_prior_ints -> [0.8824402034061426, 0.8841613171079183, 0.8876038005722782, 0.8948228965770734, 0.911212159319013, 0.9258349208103759, 0.9369372166765515, 0.9429388103895168, 0.9453814172219102]
DEBUG:root:		avg_int_time_group_coop_no_prior_ints -> 0.0003134737968444824
DEBUG:root:		construction_time_group_coop_no_prior_ints -> 50.2323157787323
DEBUG:root:	Trial 2 COMPLETED for IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 ending at 22/05/2024 at 19:57:40 (5.7357 minutes):	Time Breakdown:		Initialization: 0.0000 minutes		Training: 0.0888 minutes		Test Interventions: 5.6468 minutes		Evaluate Representation Metric: 0.0001 minutes
DEBUG:root:		Done with trial 2
DEBUG:root:Setting ac model save path to be results/mnist_intcem/acflow_sampling_0.625_model_trial_2.pt
[rank: 0] Global seed set to 44
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_3.pt
DEBUG:root:Loaded model
DEBUG:root:Restarting run because we could not find val_acc_c_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
DEBUG:root:Getting validation results.

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_avg_c_y_acc          0.8753175925925926
      test_c_accuracy          0.9536351851851852
        test_c_auc              0.888844891509667
         test_c_f1             0.9015834092199447
     test_concept_loss         3.8007829189300537
    test_current_steps          1688.27197265625
    test_horizon_limit          9.019449234008789
  test_intervention_loss               0.0
test_intervention_task_loss            0.0
         test_loss             3.8007829189300537
    test_mask_accuracy                -1.0
      test_task_loss                   0.0
      test_y_accuracy                 0.797
        test_y_auc             0.8822598719501326
         test_y_f1             0.7959276926772559
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
c_acc: 95.36%, y_acc: 79.70%, c_auc: 88.88%, y_auc: 88.23% with 76.0 epochs in 1062.48 seconds
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.8, 0.807, 0.8155]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 1
	acquisition_weight -> 0
	Validation accuracies are: [0.8015, 0.8035, 0.8085]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 10
	acquisition_weight -> 0
	Validation accuracies are: [0.804, 0.805, 0.8115]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 100
	acquisition_weight -> 0
	Validation accuracies are: [0.804, 0.804, 0.811]
Attempting CooP parameters:
	concept_entropy_weight -> 1
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.802, 0.81, 0.8245]
Attempting CooP parameters:
	concept_entropy_weight -> 10
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.8015, 0.8095, 0.828]
Attempting CooP parameters:
	concept_entropy_weight -> 100
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.801, 0.8095, 0.829]
Best params found for group_coop_no_prior are:
	concept_entropy_weight = 100
	importance_weight = 0.1
	acquisition_weight = 0
********** Results in between trial 2 **********
	 ******************************
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+
|                                                                               Method                                                                               |  Task Accuracy  |     Task AUC    | Concept Accuracy |   Concept AUC   |   25% Int Acc   |   50% Int Acc   |   75% Int Acc   |   100% Int Acc  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+
| IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 | 0.7945 ± 0.0025 | 0.8829 ± 0.0006 | 0.9562 ± 0.0026  | 0.8932 ± 0.0043 | 0.8962 ± 0.0001 | 0.9130 ± 0.0002 | 0.9280 ± 0.0019 | 0.9432 ± 0.0022 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+



[TRIAL 3/3 BEGINS AT 22/05/2024 at 19:57:40
[Training IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_3]
config:
<built-in function localtime>
	start_split -> 0
	top_k_accuracy -> None
	save_model -> True
	patience -> None
	emb_size -> 16
	extra_dims -> 0
	concept_loss_weight -> 5
	learning_rate -> 0.0001
	weight_decay -> 0.001
	c_extractor_arch -> <function get_mnist_extractor_arch.<locals>.c_extractor_arch at 0x7ff55ddd5dc0>
	optimizer -> adam
	bool -> False
	early_stopping_monitor -> val_loss
	early_stopping_mode -> min
	early_stopping_delta -> 0.0
	momentum -> 0.9
	sigmoidal_prob -> False
	training_intervention_prob -> 0.25
	train_ac_model -> False
	only_train_ac_model -> False
	train_afa_model -> False
	continue_training -> False
	cbm_aneal_rate -> 0.99999
	cbm_starting_aneal_rate -> 1
	enable_checkpointing -> False
	ac_model_config -> {'save_path': 'results/mnist_intcem/acflow_sampling_0.625_model_trial_2.pt', 'architecture': 'flow', 'max_epochs': 50, 'batch_size': 512, 'transformations': ['AF', 'TL', 'TL', 'TL', 'TL', 'AF'], 'layer_cfg': ['LR', 'CP2'], 'rnncp_units': 256, 'rnncp_layers': 2, 'linear_hids': [256, 256], 'linear_rank': -1, 'affine_hids': [256, 256], 'coupling_hids': [256, 256], 'prior': 'autoreg', 'n_components': 40, 'prior_units': 256, 'prior_layers': 2, 'prior_hids': [256, 256], 'optimizer': 'adam', 'learning_rate': 0.0001, 'decay_steps': 10000, 'decay_rate': 0.5, 'clip_gradient': 1, 'num_samples': 10}
	ac_model_nll_ratio -> 0.5
	ac_model_weight -> 2
	ac_model_rollouts -> 1
	afa_model_config -> {'act_fun': 'relu', 'ortho_init': False, 'vf_coef': 1.0, 'ent_coef': 0.0, 'clip_coef': 0.2, 'clip_vloss': False, 'normalize_advantages': False, 'num_envs': 1}
	trials -> 3
	results_dir -> results/mnist_intcem
	dataset -> mnist_add
	num_workers -> 8
	batch_size -> 512
	num_operands -> 12
	selected_digits -> [[0, 1, 2], [0, 1, 2], [0, 1, 2], [0, 1, 2], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]]
	threshold_labels -> 30
	noise_level -> 0.0
	max_epochs -> 300
	train_dataset_size -> 10000
	sampling_percent -> 0.625
	sampling_groups -> True
	c2y_layers -> [128, 128]
	skip_repr_evaluation -> True
	intervention_freq -> 1
	intervention_batch_size -> 512
	intervention_policies -> ['intcem_policy', 'optimal_greedy_no_prior', 'group_random_no_prior', 'group_coop_no_prior']
	root_dir -> /home/xty20/data
	test_subsampling -> 1
	weight_loss -> True
	use_task_class_weights -> True
	check_val_every_n_epoch -> 2
	time_last_called -> 2024/05/22 at 19:45:42
	n_concepts -> 54
	n_tasks -> 1
	concept_map -> {0: [0, 1, 2], 1: [3, 4, 5], 2: [6, 7, 8], 5: [9, 10, 11, 12, 13], 8: [14, 15, 16, 17, 18, 19, 20, 21, 22, 23], 9: [24, 25, 26, 27, 28, 29, 30, 31, 32, 33], 10: [34, 35, 36, 37, 38, 39, 40, 41, 42, 43], 11: [44, 45, 46, 47, 48, 49, 50, 51, 52, 53]}
	architecture -> IntAwareConceptEmbeddingModel
	extra_name -> Retry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625
	horizon_binary_representation -> True
	include_task_trajectory_loss -> True
	include_only_last_trajectory_loss -> True
	task_loss_weight -> 0
	intervention_weight -> 1
	intervention_task_loss_weight -> 1
	initial_horizon -> 2
	use_concept_groups -> True
	use_full_mask_distr -> False
	propagate_target_gradients -> False
	int_model_use_bn -> True
	int_model_layers -> [128, 128, 64, 64]
	intcem_task_loss_weight -> 0
	embedding_activation -> leakyrelu
	tau -> 1
	max_horizon -> 6
	horizon_uniform_distr -> True
	beta_a -> 1
	beta_b -> 3
	intervention_task_discount -> 1.1
	average_trajectory -> True
	use_horizon -> False
	initialize_discount -> False
	model_pretrain_path -> None
	horizon_rate -> 1.005
	intervention_discount -> 1
	legacy_mode -> False
[Number of parameters in model 2116331 ]
[Number of non-trainable parameters in model 2 ]
	Found cached model... loading it
Testing: 0it [00:00, ?it/s]Testing:   0%|          | 0/4 [00:00<?, ?it/s]Testing DataLoader 0:   0%|          | 0/4 [00:00<?, ?it/s]Testing DataLoader 0:  25%|██▌       | 1/4 [00:00<00:00,  5.22it/s]Testing DataLoader 0:  50%|█████     | 2/4 [00:00<00:00,  5.35it/s]Testing DataLoader 0:  75%|███████▌  | 3/4 [00:00<00:00,  5.43it/s]Testing DataLoader 0: 100%|██████████| 4/4 [00:00<00:00,  5.48it/s]Testing DataLoader 0: 100%|██████████| 4/4 [00:00<00:00,  5.47it/s]DEBUG:root:Restarting run because we could not find test_acc_c_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
DEBUG:root:Getting test results without interventions.

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_avg_c_y_acc          0.8651990740740741
      test_c_accuracy           0.955398148148148
        test_c_auc             0.8916680750727951
         test_c_f1             0.9047293460612864
     test_concept_loss          3.713636636734009
    test_current_steps         1808.4639892578125
    test_horizon_limit          9.019449234008789
  test_intervention_loss               0.0
test_intervention_task_loss            0.0
         test_loss              3.713636636734009
    test_mask_accuracy                -1.0
      test_task_loss                   0.0
      test_y_accuracy                 0.775
        test_y_auc             0.8776372029920757
         test_y_f1             0.8149191768866533
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
val_c_acc: 95.54%, val_y_acc: 77.50%, val_c_auc: 89.17%, val_y_auc: 87.76% with 82.0 epochs in 1140.32 seconds
Testing: 0it [00:00, ?it/s]Testing:   0%|          | 0/20 [00:00<?, ?it/s]Testing DataLoader 0:   0%|          | 0/20 [00:00<?, ?it/s]Testing DataLoader 0:   5%|▌         | 1/20 [00:00<00:03,  5.56it/s]Testing DataLoader 0:  10%|█         | 2/20 [00:00<00:03,  5.49it/s]Testing DataLoader 0:  15%|█▌        | 3/20 [00:00<00:03,  5.52it/s]Testing DataLoader 0:  20%|██        | 4/20 [00:00<00:02,  5.50it/s]Testing DataLoader 0:  25%|██▌       | 5/20 [00:00<00:02,  5.54it/s]Testing DataLoader 0:  30%|███       | 6/20 [00:01<00:02,  5.57it/s]Testing DataLoader 0:  35%|███▌      | 7/20 [00:01<00:02,  5.59it/s]Testing DataLoader 0:  40%|████      | 8/20 [00:01<00:02,  5.60it/s]Testing DataLoader 0:  45%|████▌     | 9/20 [00:01<00:01,  5.60it/s]Testing DataLoader 0:  50%|█████     | 10/20 [00:01<00:01,  5.61it/s]Testing DataLoader 0:  55%|█████▌    | 11/20 [00:01<00:01,  5.61it/s]Testing DataLoader 0:  60%|██████    | 12/20 [00:02<00:01,  5.61it/s]Testing DataLoader 0:  65%|██████▌   | 13/20 [00:02<00:01,  5.62it/s]Testing DataLoader 0:  70%|███████   | 14/20 [00:02<00:01,  5.62it/s]Testing DataLoader 0:  75%|███████▌  | 15/20 [00:02<00:00,  5.63it/s]Testing DataLoader 0:  80%|████████  | 16/20 [00:02<00:00,  5.63it/s]Testing DataLoader 0:  85%|████████▌ | 17/20 [00:03<00:00,  5.63it/s]Testing DataLoader 0:  90%|█████████ | 18/20 [00:03<00:00,  5.63it/s]Testing DataLoader 0:  95%|█████████▌| 19/20 [00:03<00:00,  5.63it/s]Testing DataLoader 0: 100%|██████████| 20/20 [00:03<00:00,  5.65it/s]Testing DataLoader 0: 100%|██████████| 20/20 [00:03<00:00,  5.64it/s]DEBUG:root:Restarting run because we could not find test_acc_y_intcem_policy_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 44
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_3.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.intcem_policy.IntCemInterventionPolicy'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 2 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.13% (accuracy is 75.77%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 2 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 89.82% (accuracy is 78.32%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 2 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 90.31% (accuracy is 78.83%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 2 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 90.52% (accuracy is 79.11%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 2 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 90.71% (accuracy is 79.27%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 2 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 90.90% (accuracy is 79.42%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 2 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 91.26% (accuracy is 79.61%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 2 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 92.19% (accuracy is 80.20%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 2 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 93.99% (accuracy is 81.55%).
DEBUG:root:	Average intervention took 0.00025 seconds and construction took 0.00007 seconds.
	In total interventions took 22.81056 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.13% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 89.82% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 90.31% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 90.52% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 90.71% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 90.90% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 91.26% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 92.19% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 93.99% (avg int time is 0.00025s and construction time is 0.00007s).
DEBUG:root:Restarting run because we could not find test_acc_y_optimal_greedy_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 44
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_3.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.optimal.GreedyOptimal'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 2 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.13% (accuracy is 75.77%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 2 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 95.93% (accuracy is 84.29%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 2 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 97.44% (accuracy is 86.91%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 2 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 97.85% (accuracy is 87.92%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 2 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 97.95% (accuracy is 88.24%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 2 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 97.95% (accuracy is 88.26%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 2 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 97.78% (accuracy is 88.04%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 2 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 97.17% (accuracy is 87.07%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 2 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 93.99% (accuracy is 81.55%).
DEBUG:root:	Average intervention took 0.00025 seconds and construction took 0.00006 seconds.
	In total interventions took 22.25571 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.13% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 95.93% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 97.44% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 97.85% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 97.95% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 97.95% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 97.78% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 97.17% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 93.99% (avg int time is 0.00025s and construction time is 0.00006s).
DEBUG:root:Restarting run because we could not find test_acc_y_group_random_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 44
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_3.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.random.IndependentRandomMaskIntPolicy'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 2 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.13% (accuracy is 75.77%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 2 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 88.84% (accuracy is 76.49%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 2 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 89.45% (accuracy is 77.19%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 2 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 90.45% (accuracy is 77.95%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 2 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 91.15% (accuracy is 78.36%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 2 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 91.80% (accuracy is 79.16%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 2 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 92.52% (accuracy is 79.76%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 2 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 93.33% (accuracy is 80.62%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 2 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 93.99% (accuracy is 81.55%).
DEBUG:root:	Average intervention took 0.00013 seconds and construction took 0.00003 seconds.
	In total interventions took 11.99690 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.13% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 88.84% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 89.45% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 90.45% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 91.15% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 91.80% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 92.52% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 93.33% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 93.99% (avg int time is 0.00013s and construction time is 0.00003s).
DEBUG:root:Restarting run because we could not find test_acc_y_group_coop_no_prior_ints_IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in old results.
[rank: 0] Global seed set to 44
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_3.pt
[rank: 0] Global seed set to 44
DEBUG:root:Loading trained model from results/mnist_intcem/IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625_lambda_fold_3.pt
DEBUG:root:Intervention groups: [0, 1, 2, 3, 4, 5, 6, 7, 8]
DEBUG:root:Intervening in <class 'cem.models.intcbm.IntAwareConceptEmbeddingModel'> using <class 'cem.interventions.coop.CooP'>
DEBUG:root:Intervening with 0 out of 8 concept groups
DEBUG:root:	For split 2 with 0 groups intervened
DEBUG:root:	Test AUC when intervening with 0 concept groups is 88.13% (accuracy is 75.77%).
DEBUG:root:Intervening with 1 out of 8 concept groups
DEBUG:root:	For split 2 with 1 groups intervened
DEBUG:root:	Test AUC when intervening with 1 concept groups is 88.27% (accuracy is 76.19%).
DEBUG:root:Intervening with 2 out of 8 concept groups
DEBUG:root:	For split 2 with 2 groups intervened
DEBUG:root:	Test AUC when intervening with 2 concept groups is 88.50% (accuracy is 76.60%).
DEBUG:root:Intervening with 3 out of 8 concept groups
DEBUG:root:	For split 2 with 3 groups intervened
DEBUG:root:	Test AUC when intervening with 3 concept groups is 89.34% (accuracy is 77.40%).
DEBUG:root:Intervening with 4 out of 8 concept groups
DEBUG:root:	For split 2 with 4 groups intervened
DEBUG:root:	Test AUC when intervening with 4 concept groups is 90.94% (accuracy is 78.63%).
DEBUG:root:Intervening with 5 out of 8 concept groups
DEBUG:root:	For split 2 with 5 groups intervened
DEBUG:root:	Test AUC when intervening with 5 concept groups is 92.29% (accuracy is 79.68%).
DEBUG:root:Intervening with 6 out of 8 concept groups
DEBUG:root:	For split 2 with 6 groups intervened
DEBUG:root:	Test AUC when intervening with 6 concept groups is 93.15% (accuracy is 80.67%).
DEBUG:root:Intervening with 7 out of 8 concept groups
DEBUG:root:	For split 2 with 7 groups intervened
DEBUG:root:	Test AUC when intervening with 7 concept groups is 93.76% (accuracy is 81.21%).
DEBUG:root:Intervening with 8 out of 8 concept groups
DEBUG:root:	For split 2 with 8 groups intervened
DEBUG:root:	Test AUC when intervening with 8 concept groups is 93.99% (accuracy is 81.55%).
DEBUG:root:	Average intervention took 0.00031 seconds and construction took 50.90880 seconds.
	In total interventions took 27.92517 seconds
DEBUG:root:		Test AUC when intervening with 0 concept groups is 88.13% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:		Test AUC when intervening with 1 concept groups is 88.27% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:		Test AUC when intervening with 2 concept groups is 88.50% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:		Test AUC when intervening with 3 concept groups is 89.34% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:		Test AUC when intervening with 4 concept groups is 90.94% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:		Test AUC when intervening with 5 concept groups is 92.29% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:		Test AUC when intervening with 6 concept groups is 93.15% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:		Test AUC when intervening with 7 concept groups is 93.76% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:		Test AUC when intervening with 8 concept groups is 93.99% (avg int time is 0.00031s and construction time is 50.90880s).
DEBUG:root:	Results for IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 in split 2:
DEBUG:root:		test_acc_y -> 0.7688
DEBUG:root:		test_auc_y -> 0.8810321206648356
DEBUG:root:		test_f1_y -> 0.8023239158573401
DEBUG:root:		test_acc_c -> 0.9561555555555559
DEBUG:root:		test_auc_c -> 0.8946005208729615
DEBUG:root:		test_f1_c -> 0.9068178533403696
DEBUG:root:		training_epochs -> 82.0
DEBUG:root:		training_time -> 1140.3233177661896
DEBUG:root:		num_trainable_params -> 0
DEBUG:root:		num_non_trainable_params -> 2116333
DEBUG:root:		test_acc_y_intcem_policy_ints -> [0.8813020873751138, 0.8982411591756804, 0.9031044466493635, 0.9051993324702385, 0.9071219313924165, 0.9090072558721222, 0.9125639252601161, 0.9218672594383667, 0.9398825888138823]
DEBUG:root:		avg_int_time_intcem_policy_ints -> 0.00025345066123538546
DEBUG:root:		construction_time_intcem_policy_ints -> 7.295608520507812e-05
DEBUG:root:		test_acc_y_optimal_greedy_no_prior_ints -> [0.8813020873751138, 0.9593423044322988, 0.9743574210418852, 0.9784643649407883, 0.9795423323611383, 0.9794875778169099, 0.9777690452402712, 0.9717495319974756, 0.9398825888138823]
DEBUG:root:		avg_int_time_optimal_greedy_no_prior_ints -> 0.00024728572103712294
DEBUG:root:		construction_time_optimal_greedy_no_prior_ints -> 5.841255187988281e-05
DEBUG:root:		test_acc_y_group_random_no_prior_ints -> [0.8813020873751138, 0.8883550339346479, 0.8944642674460741, 0.9044550547914915, 0.911543929110456, 0.9179963849600837, 0.925164796794478, 0.9332790998806615, 0.9398825888138823]
DEBUG:root:		avg_int_time_group_random_no_prior_ints -> 0.0001332988739013672
DEBUG:root:		construction_time_group_random_no_prior_ints -> 2.6702880859375e-05
DEBUG:root:		test_acc_y_group_coop_no_prior_ints -> [0.8813020873751138, 0.8826783193946729, 0.8850069769256524, 0.8933902957464452, 0.9094191130998541, 0.9229455354345937, 0.9314868369251308, 0.9375935046859362, 0.9398825888138823]
DEBUG:root:		avg_int_time_group_coop_no_prior_ints -> 0.0003102796819474962
DEBUG:root:		construction_time_group_coop_no_prior_ints -> 50.90879821777344
DEBUG:root:	Trial 3 COMPLETED for IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 ending at 22/05/2024 at 20:03:28 (5.7985 minutes):	Time Breakdown:		Initialization: 0.0000 minutes		Training: 0.0901 minutes		Test Interventions: 5.7083 minutes		Evaluate Representation Metric: 0.0001 minutes
DEBUG:root:		Done with trial 3
DEBUG:root:		Done with trial 3

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
        Test metric               DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_avg_c_y_acc          0.8624777777777778
      test_c_accuracy          0.9561555555555559
        test_c_auc             0.8946005208729615
         test_c_f1             0.9068178533403696
     test_concept_loss         3.6467015743255615
    test_current_steps          1820.27197265625
    test_horizon_limit          9.019449234008789
  test_intervention_loss               0.0
test_intervention_task_loss            0.0
         test_loss             3.6467015743255615
    test_mask_accuracy                -1.0
      test_task_loss                   0.0
      test_y_accuracy                0.7688
        test_y_auc             0.8810321206648356
         test_y_f1             0.8023239158573401
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
c_acc: 95.62%, y_acc: 76.88%, c_auc: 89.46%, y_auc: 88.10% with 82.0 epochs in 1140.32 seconds
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.7735, 0.7765, 0.778]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 1
	acquisition_weight -> 0
	Validation accuracies are: [0.772, 0.774, 0.7745]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 10
	acquisition_weight -> 0
	Validation accuracies are: [0.774, 0.773, 0.774]
Attempting CooP parameters:
	concept_entropy_weight -> 0.1
	importance_weight -> 100
	acquisition_weight -> 0
	Validation accuracies are: [0.7735, 0.773, 0.777]
Attempting CooP parameters:
	concept_entropy_weight -> 1
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.7725, 0.7745, 0.792]
Attempting CooP parameters:
	concept_entropy_weight -> 10
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.7725, 0.774, 0.795]
Attempting CooP parameters:
	concept_entropy_weight -> 100
	importance_weight -> 0.1
	acquisition_weight -> 0
	Validation accuracies are: [0.7725, 0.7745, 0.7945]
Best params found for group_coop_no_prior are:
	concept_entropy_weight = 100
	importance_weight = 0.1
	acquisition_weight = 0
********** Results in between trial 3 **********
	 ******************************
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+
|                                                                               Method                                                                               |  Task Accuracy  |     Task AUC    | Concept Accuracy |   Concept AUC   |   25% Int Acc   |   50% Int Acc   |   75% Int Acc   |   100% Int Acc  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+
| IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 | 0.7859 ± 0.0123 | 0.8823 ± 0.0010 | 0.9562 ± 0.0021  | 0.8936 ± 0.0036 | 0.8956 ± 0.0008 | 0.9125 ± 0.0007 | 0.9271 ± 0.0020 | 0.9421 ± 0.0024 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+



********** Results after trial 3 **********
	 ******************************
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+
|                                                                               Method                                                                               |  Task Accuracy  |     Task AUC    | Concept Accuracy |   Concept AUC   |   25% Int Acc   |   50% Int Acc   |   75% Int Acc   |   100% Int Acc  |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+
| IntAwareConceptEmbeddingModelRetry_concept_loss_weight_5_intervention_weight_1_horizon_rate_1.005_intervention_discount_1_task_discount_1.1_sampling_percent_0.625 | 0.7859 ± 0.0123 | 0.8823 ± 0.0010 | 0.9562 ± 0.0021  | 0.8936 ± 0.0036 | 0.8956 ± 0.0008 | 0.9125 ± 0.0007 | 0.9271 ± 0.0020 | 0.9421 ± 0.0024 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-----------------+------------------+-----------------+-----------------+-----------------+-----------------+-----------------+



